{"version":3,"sources":["../src/datasource.js"],"names":["_","BitmovinAnalyticsDatasource","instanceSettings","$q","backendSrv","templateSrv","type","url","name","q","withCredentials","headers","jsonData","apiKey","tenantOrgId","length","basicAuth","options","query","buildQueryParameters","targets","filter","t","hide","when","data","getAdhocFilters","adhocFilters","targetResponsePromises","map","target","metric","dimension","resultFormat","interval","licenseKey","license","start","range","from","toISOString","end","to","filters","operator","value","convertFilterValueToProperType","percentileValue","doRequest","method","resultTarget","alias","refId","Promise","all","then","targetResponses","datapoints","response","result","rows","row","config","orderBy","getLicenses","status","message","title","datasourceRequest","parseInt"],"mappings":"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","file":"datasource.js","sourcesContent":["import _ from \"lodash\";\n\nexport class BitmovinAnalyticsDatasource {\n\n  constructor(instanceSettings, $q, backendSrv, templateSrv) {\n    this.type = instanceSettings.type;\n    this.url = instanceSettings.url;\n    this.name = instanceSettings.name;\n    this.q = $q;\n    this.backendSrv = backendSrv;\n    this.templateSrv = templateSrv;\n    this.withCredentials = instanceSettings.withCredentials;\n\n    this.headers = {\n      'Content-Type': 'application/json',\n      'X-Api-Key': instanceSettings.jsonData.apiKey,\n    };\n\n    if (typeof instanceSettings.tenantOrgId === 'string' && instanceSettings.tenantOrgId.length > 0) {\n      this.headers['X-Tenant-Org-Id'] = instanceSettings.tenantOrgId;\n    }\n\n    if (typeof instanceSettings.basicAuth === 'string' && instanceSettings.basicAuth.length > 0) {\n      this.headers['Authorization'] = instanceSettings.basicAuth;\n    }\n  }\n\n  query(options) {\n    var query = this.buildQueryParameters(options);\n    query.targets = query.targets.filter(t => !t.hide);\n\n    if (query.targets.length <= 0) {\n      return this.q.when({data: []});\n    }\n\n    if (this.templateSrv.getAdhocFilters) {\n      query.adhocFilters = this.templateSrv.getAdhocFilters(this.name);\n    } else {\n      query.adhocFilters = [];\n    }\n\n    let targetResponsePromises = _.map(query.targets, target => {\n      target.metric = target.metric || 'count';\n      target.dimension = target.dimension || 'LICENSE_KEY';\n      target.resultFormat = target.resultFormat || 'time_series';\n      target.interval = target.interval || 'MINUTE';\n\n      var data = {\n        licenseKey: target.license,\n        dimension: target.dimension,\n        start: options.range.from.toISOString(),\n        end: options.range.to.toISOString(),\n        filters: _.map(target.filter, filter => {\n          return {\n            name: filter.name,\n            operator: filter.operator,\n            value: this.convertFilterValueToProperType(filter)\n          }\n        })\n      };\n\n      if (target.metric === 'percentile') {\n        data['percentile'] = target.percentileValue;\n      }\n\n      if (target.resultFormat === 'time_series') {\n        data['interval'] = target.interval;\n      }\n\n      return this.doRequest({\n        url: this.url + '/analytics/queries/' + target.metric,\n        data: data,\n        method: 'POST',\n        resultTarget: target.alias || target.refId,\n        resultFormat: target.resultFormat\n      });\n    });\n\n    return Promise.all(targetResponsePromises).then(targetResponses => {\n      return {\n        data: _.map(targetResponses, response => {\n          var datapoints = _.map(response.data.data.result.rows, row => {\n            return [row[1], row[0]]; // value, timestamp\n          });\n\n          if (response.config.resultFormat === 'time_series') {\n            datapoints = _.orderBy(datapoints, [1], 'asc')\n          }\n\n          return {\n            target: response.config.resultTarget,\n            datapoints: datapoints\n          };\n        })\n      };\n    });\n  }\n\n  testDatasource() {\n    return this.getLicenses().then(response => {\n      if (response.status === 200) {\n        return { status: \"success\", message: \"Data source is working\", title: \"Success\" };\n      }\n    });\n  }\n\n  annotationQuery(options) {\n\n  }\n\n  metricFindQuery(query) {\n\n  }\n\n  doRequest(options) {\n    options.withCredentials = this.withCredentials;\n    options.headers = this.headers;\n\n    return this.backendSrv.datasourceRequest(options);\n  }\n\n  buildQueryParameters(options) {\n    return options;\n  }\n\n  getLicenses() {\n    return this.doRequest({\n      url: this.url + '/analytics/licenses',\n      method: 'GET',\n    });\n  }\n\n  convertFilterValueToProperType(filter) {\n    switch(filter.name) {\n      case 'IS_LIVE':\n      case 'IS_CASTING':\n      case 'IS_MUTED': return filter.value === 'true';\n      case 'PLAYER_STARTUPTIME':\n      case 'VIDEO_STARTUPTIME':\n      case 'CLIENT_TIME':\n      case 'VIDEOTIME':\n      case 'VIDEOTIME':\n      case 'STARTUPTIME':\n      case 'PAGE_LOAD_TIME': return parseInt(filter.value, 10);\n      default: return filter.value\n    }\n  }\n}\n"]}