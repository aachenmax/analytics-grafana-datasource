{"version":3,"sources":["../src/query_ctrl.js"],"names":["QueryCtrl","_","REMOVE_FILTER_TEXT","DEFAULT_OPERATOR","BitmovinAnalyticsDatasourceQueryCtrl","$scope","$injector","templateSrv","$q","uiSegmentSrv","scope","metrics","fields","operators","licenses","resultFormats","intervals","filterSegment","newPlusButton","groupBySegment","groupByParts","filterSegments","target","metric","percentileValue","dimension","license","resultFormat","interval","alias","groupBy","filter","datasource","getLicenses","then","response","status","data","result","items","item","name","licenseKey","push","panelCtrl","refresh","options","map","field","value","text","Promise","resolve","unshift","op","segment","$index","params","def","type","optional","plusButton","html","operator","filterValue","selectParts","part","evt","splice","when","templateUrl"],"mappings":"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","file":"query_ctrl.js","sourcesContent":["import {QueryCtrl} from 'app/plugins/sdk';\nimport './css/query-editor.css!'\n\nimport _ from 'lodash';\n\nconst REMOVE_FILTER_TEXT = '-- Remove Filter --';\nconst DEFAULT_OPERATOR = 'EQ';\n\nexport class BitmovinAnalyticsDatasourceQueryCtrl extends QueryCtrl {\n\n  constructor($scope, $injector, templateSrv, $q, uiSegmentSrv)  {\n    super($scope, $injector);\n\n    this.scope = $scope;\n    this.$q = $q;\n    this.uiSegmentSrv = uiSegmentSrv;\n\n    this.metrics = ['count', 'sum', 'avg', 'min', 'max', 'stddev', 'percentile', 'variance', 'median'];\n    this.fields = ['LICENSE_KEY', 'PLAYER_KEY', 'IMPRESSION_ID', 'USER_ID', 'DOMAIN', 'PATH', 'LANGUAGE', 'PLAYER_TECH', 'SCREEN_WIDTH',\n                   'SCREEN_HEIGHT', 'IP_ADDRESS', 'STREAM_FORMAT', 'PLAYER', 'PLAYER_VERSION', 'ANALYTICS_VERSION', 'VIDEO_DURATION',\n                   'IS_LIVE', 'IS_CASTING', 'IS_MUTED', 'VIDEO_ID', 'PLAYER_STARTUPTIME', 'VIDEO_STARTUPTIME', 'CUSTOM_USER_ID',\n                   'CLIENT_TIME', 'SIZE', 'VIDEO_WINDOW_WIDTH', 'VIDEO_WINDOW_HEIGHT', 'DROPPED_FRAMES', 'PLAYED', 'PAUSED',\n                   'BUFFERED', 'AD', 'SEEKED', 'VIDEO_PLAYBACK_WIDTH', 'VIDEO_PLAYBACK_HEIGHT', 'VIDEO_BITRATE', 'AUDIO_BITRATE',\n                   'VIDEOTIME_START', 'VIDEOTIME_END', 'DURATION', 'STARTUPTIME', 'BROWSER', 'BROWSER_VERSION_MAJOR', 'OPERATINGSYSTEM',\n                   'OPERATINGSYSTEM_VERSION_MAJOR', 'DEVICE_TYPE', 'COUNTRY', 'REGION', 'CITY', 'CDN_PROVIDER', 'MPD_URL', 'M3U8_URL',\n                   'PROG_URL', 'ERROR_CODE', 'SCALE_FACTOR', 'PAGE_LOAD_TIME', 'PAGE_LOAD_TYPE', 'AUTOPLAY', 'CUSTOM_DATA_1',\n                   'CUSTOM_DATA_2', 'CUSTOM_DATA_3', 'CUSTOM_DATA_4', 'CUSTOM_DATA_5', 'EXPERIMENT_NAME'];\n    this.operators = ['EQ', 'NE', 'LT', 'LTE', 'GT', 'GTE', 'CONTAINS', 'NOTCONTAINS']\n    this.licenses = [];\n    this.resultFormats = ['time_series', 'table'];\n    this.intervals = ['MINUTE', 'HOUR', 'DAY', 'MONTH'];\n    this.filterSegment = this.uiSegmentSrv.newPlusButton();\n    this.groupBySegment = this.uiSegmentSrv.newPlusButton();\n    this.groupByParts = [];\n    this.filterSegments = [];\n\n    this.target.metric = this.target.metric || this.metrics[0];\n    this.target.percentileValue = this.target.percentileValue || 95;\n    this.target.dimension = this.target.dimension || this.fields[0];\n    this.target.license = this.target.license || this.licenses[0];\n    this.target.resultFormat = this.target.resultFormat || this.resultFormats[0];\n    this.target.interval = this.target.interval || this.intervals[0];\n    this.target.alias = this.target.alias || '';\n    this.target.groupBy = this.target.groupBy || [];\n    this.target.filter = this.target.filter || [];\n\n    this.datasource.getLicenses().then(response => {\n      if (response.status === 200) {\n        this.licenses = [];\n\n        for (var item of response.data.data.result.items) {\n          item['label'] = item.name + ' (' + item.licenseKey + ')';\n          this.licenses.push(item);\n        }\n\n        this.target.license = this.licenses[0].licenseKey;\n      }\n    });\n  }\n\n  onChangeInternal() {\n    this.panelCtrl.refresh(); // Asks the panel to refresh data.\n  }\n\n  getGroupByOptions() {\n    let options = _.map(this.fields, function(field) {\n      return { value: field, text: field };\n    });\n\n    return Promise.resolve(options);\n  }\n\n  getFilterOptions() {\n    let options = _.map(this.fields, function(field) {\n      return { value: field, text: field };\n    });\n\n    return Promise.resolve(options);\n  }\n\n  getFilterSegmentOptions() {\n    var options = _.map(this.fields, function(field) {\n      return { value: field, text: field };\n    });\n\n    options.unshift({\n      value: REMOVE_FILTER_TEXT,\n      text: REMOVE_FILTER_TEXT\n    })\n\n    return Promise.resolve(options);\n  }\n\n  getFilterOperatorOptions() {\n    let options = _.map(this.operators, function(op) {\n      return { value: op, text: op };\n    });\n\n    return Promise.resolve(options);\n  }\n\n  getFilterValueOptions(segment, $index) {\n    return Promise.resolve([]);\n  }\n\n  groupByAction() {\n    this.target.groupBy.push(this.groupBySegment.value);\n\n    this.groupByParts.push({\n      params: [this.groupBySegment.value],\n      def: {\n        type: 'dimension',\n        params: [{\n          optional: false\n        }]\n      }\n    });\n\n    const plusButton = this.uiSegmentSrv.newPlusButton();\n    this.groupBySegment.value = plusButton.value;\n    this.groupBySegment.html = plusButton.html;\n    this.panelCtrl.refresh();\n  }\n\n  filterAction() {\n    this.target.filter.push({\n      name: this.filterSegment.value,\n      operator: DEFAULT_OPERATOR,\n      value: ''\n    });\n\n    this.filterSegments.push({\n      html: this.filterSegment.value,\n      operator: {html: DEFAULT_OPERATOR},\n      filterValue: {html: 'set filter value'}\n    });\n\n    const plusButton = this.uiSegmentSrv.newPlusButton();\n    this.filterSegment.value = plusButton.value;\n    this.filterSegment.html = plusButton.html;\n    this.panelCtrl.refresh();\n  }\n\n  handleGroupByPartEvent(selectParts, part, evt) {\n    switch (evt.name) {\n      case 'action': {\n        this.target.groupBy.splice(part, 1);\n        this.groupByParts.splice(part, 1);\n        this.panelCtrl.refresh();\n        break;\n      }\n      case 'get-part-actions': {\n        return this.$q.when([{ text: 'Remove', value: 'remove-part' }]);\n      }\n    }\n  }\n\n  filterSegmentUpdate(segment, $index) {\n    if (segment.value === REMOVE_FILTER_TEXT) {\n      this.target.filter.splice($index, 1);\n      this.filterSegments.splice($index, 1);\n    } else {\n      this.target.filter[$index].name = segment.value;\n    }\n\n    this.panelCtrl.refresh();\n  }\n\n  filterOperatorSegmentUpdate(segment, $index) {\n    this.target.filter[$index].operator = segment.operator.value;\n    this.panelCtrl.refresh();\n  }\n\n  filterValueSegmentUpdate(segment, $index) {\n    this.target.filter[$index].value = segment.filterValue.value;\n    this.panelCtrl.refresh();\n  }\n}\n\nBitmovinAnalyticsDatasourceQueryCtrl.templateUrl = 'partials/query.editor.html';\n\n"]}